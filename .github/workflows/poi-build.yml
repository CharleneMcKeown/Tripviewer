name: Build poi

on:
  push:
    paths:
      - 'apis/poi/**'
      - '.github/workflows/poi-build.yml'
  pull_request:
    paths:
      - 'apis/poi/**'
      - '.github/workflows/poi-build.yml'
    branches: [ main ]

env:
  webapp_name: openhack7475poi
  ACR_NAME: ${{ secrets.ACR_NAME }} 
  ACR_USER: ${{ secrets.ACR_USER }} 
  IMAGE_NAME: devopsoh/api-poi 
  IMAGE_TAG: ${{ github.run_number }}

jobs:
  build_poi:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 2.1
    - name: Install dependencies
      run: dotnet restore 'apis/poi/poi.sln'
    - name: Build
      run: dotnet build 'apis/poi/poi.sln' --configuration Release --no-restore
    - name: Test
      run: dotnet test 'apis/poi/tests/UnitTests/UnitTests.csproj' --no-restore --verbosity normal

    - name: Create Issue Action
      if: ${{ failure() }}
      uses: nashmaniac/create-issue-action@v1.1
      with:
        # Title of the issue
        title: Build failed
        # Token of the user that creates the issue
        token: ${{secrets.GITHUB_TOKEN}}
        # Assignees of the issue
        assignees: ${{github.actor}}
        
  push_to_acr:
    name: Build Docker Image and push to ACR
    needs: build_poi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build and Tag Docker Image
        if: github.ref == 'refs/heads/main'
        run: | 
          docker build . -t $ACR_NAME/$IMAGE_NAME:$IMAGE_TAG
        working-directory: apis/poi/web
      - name: Login to ACR 
        if: github.ref == 'refs/heads/main'
        run:  docker login ${{ secrets.ACR_NAME }} -u ${{ secrets.ACR_USER }} -p ${{ secrets.ACR_PASSWORD }} 
      - name: Push to ACR
        if: github.ref == 'refs/heads/main'
        run: |
          docker push $ACR_NAME/$IMAGE_NAME:$IMAGE_TAG

  publish_web_app:
    needs: [build_poi, push_to_acr]
    runs-on: ubuntu-latest
    steps:
      - name: Azure authentication
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS  }}
      - name: Deploy image to production slot
        if: github.ref == 'refs/heads/main'
        uses: Azure/webapps-deploy@v2
        with:
          app-name: ${{ env.webapp_name }}
          images: ${{ env.ACR_NAME }}/${{ env.IMAGE_NAME }}:${{github.run_number}}
